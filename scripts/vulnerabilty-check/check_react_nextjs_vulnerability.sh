#!/bin/bash

# React Server Components ì·¨ì•½ì  ì ê²€ ìŠ¤í¬ë¦½íŠ¸
# CVE-2025-55182, CVE-2025-66478
# Rocky Linux í™˜ê²½

echo "=================================================="
echo "React/Next.js ì·¨ì•½ì  ì ê²€ ìŠ¤í¬ë¦½íŠ¸"
echo "CVE-2025-55182, CVE-2025-66478"
echo "ì ê²€ ì‹œì‘ ì‹œê°„: $(date)"
echo "=================================================="
echo ""

# ê²°ê³¼ ì €ì¥ íŒŒì¼
REPORT_FILE="vulnerability_check_report_$(date +%Y%m%d_%H%M%S).txt"

# ë¡œê·¸ í•¨ìˆ˜
log_result() {
    echo "$1" | tee -a "$REPORT_FILE"
}

log_result "=================================================="
log_result "React/Next.js ì·¨ì•½ì  ì ê²€ ë³´ê³ ì„œ"
log_result "ì ê²€ ì‹œê°„: $(date)"
log_result "í˜¸ìŠ¤íŠ¸ëª…: $(hostname)"
log_result "=================================================="
log_result ""

# 1. Node.js ì„¤ì¹˜ ì—¬ë¶€ í™•ì¸
log_result "[1] Node.js ì„¤ì¹˜ í™•ì¸"
if command -v node &> /dev/null; then
    NODE_VERSION=$(node -v)
    log_result "âœ“ Node.js ì„¤ì¹˜ë¨: $NODE_VERSION"
    log_result "  ê²½ë¡œ: $(which node)"
else
    log_result "âœ— Node.jsê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
    log_result ""
    log_result "ì ê²€ ì¢…ë£Œ: Node.jsê°€ ì—†ì–´ ì¶”ê°€ ì ê²€ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."
    exit 0
fi
log_result ""

# 2. npm ì„¤ì¹˜ ì—¬ë¶€ í™•ì¸
log_result "[2] npm ì„¤ì¹˜ í™•ì¸"
if command -v npm &> /dev/null; then
    NPM_VERSION=$(npm -v)
    log_result "âœ“ npm ì„¤ì¹˜ë¨: $NPM_VERSION"
else
    log_result "âœ— npmì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
fi
log_result ""

# 3. í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ê²€ìƒ‰
log_result "[3] Node.js í”„ë¡œì íŠ¸ ê²€ìƒ‰ (package.json íŒŒì¼ ê¸°ì¤€)"
log_result "ê²€ìƒ‰ ê²½ë¡œ: /home, /var/www, /opt, /usr/local"
log_result ""

# package.json íŒŒì¼ ì°¾ê¸° (ì¼ë°˜ì ì¸ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ê²½ë¡œ)
PACKAGE_JSON_FILES=$(find /home /var/www /opt /usr/local -name "package.json" 2>/dev/null)

if [ -z "$PACKAGE_JSON_FILES" ]; then
    log_result "âœ— package.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    log_result "  í”„ë¡œì íŠ¸ê°€ ì—†ê±°ë‚˜ ë‹¤ë¥¸ ê²½ë¡œì— ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
    exit 0
fi

PROJECT_COUNT=$(echo "$PACKAGE_JSON_FILES" | wc -l)
log_result "âœ“ ì´ $PROJECT_COUNT ê°œì˜ í”„ë¡œì íŠ¸ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤."
log_result ""

# 4. ê° í”„ë¡œì íŠ¸ë³„ ì·¨ì•½ì  ì ê²€
VULNERABLE_COUNT=0
SAFE_COUNT=0
PROJECT_NUM=0

while IFS= read -r PACKAGE_FILE; do
    PROJECT_NUM=$((PROJECT_NUM + 1))
    PROJECT_DIR=$(dirname "$PACKAGE_FILE")
    
    log_result "------------------------------------------------"
    log_result "í”„ë¡œì íŠ¸ #$PROJECT_NUM: $PROJECT_DIR"
    log_result "------------------------------------------------"
    
    # package.json íŒŒì¼ì´ ì½ì„ ìˆ˜ ìˆëŠ”ì§€ í™•ì¸
    if [ ! -r "$PACKAGE_FILE" ]; then
        log_result "âœ— package.json íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ê¶Œí•œ ë¬¸ì œ)"
        log_result ""
        continue
    fi
    
    # jq ì„¤ì¹˜ í™•ì¸
    if ! command -v jq &> /dev/null; then
        log_result "âš  jqê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•Šì•„ ìˆ˜ë™ íŒŒì‹±ì„ ì‹œë„í•©ë‹ˆë‹¤."
        # jq ì—†ì´ grepìœ¼ë¡œ í™•ì¸
        REACT_DEPS=$(grep -E "react-server-dom-webpack|react-server-dom-parcel|react-server-dom-turbopack|next" "$PACKAGE_FILE" | grep -v "//")
    else
        # jqë¡œ íŒŒì‹±
        REACT_DEPS=$(jq -r '.dependencies, .devDependencies | to_entries[] | select(.key | test("react-server-dom-webpack|react-server-dom-parcel|react-server-dom-turbopack|next")) | "\(.key): \(.value)"' "$PACKAGE_FILE" 2>/dev/null)
    fi
    
    if [ -z "$REACT_DEPS" ]; then
        log_result "âœ“ React Server Components ë˜ëŠ” Next.jsë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
        SAFE_COUNT=$((SAFE_COUNT + 1))
        log_result ""
        continue
    fi
    
    log_result "ë°œê²¬ëœ ì˜ì¡´ì„±:"
    log_result "$REACT_DEPS"
    log_result ""
    
    # ì·¨ì•½ì  ì—¬ë¶€ íŒë‹¨
    IS_VULNERABLE=0
    
    # react-server-dom-webpack ì ê²€
    if echo "$REACT_DEPS" | grep -q "react-server-dom-webpack"; then
        VERSION=$(echo "$REACT_DEPS" | grep "react-server-dom-webpack" | sed 's/.*: //; s/"//g; s/,//g; s/[^0-9.].*//g')
        log_result "âš  react-server-dom-webpack ë°œê²¬: $VERSION"
        
        if [[ "$VERSION" =~ ^19\.0$ ]] || [[ "$VERSION" =~ ^19\.1\.[01]$ ]] || [[ "$VERSION" =~ ^19\.2\.0$ ]]; then
            log_result "  ğŸ”´ ì·¨ì•½í•œ ë²„ì „ì…ë‹ˆë‹¤!"
            log_result "  ê¶Œì¥ ì¡°ì¹˜: 19.0.1, 19.1.2, ë˜ëŠ” 19.2.1 ì´ìƒìœ¼ë¡œ ì—…ë°ì´íŠ¸"
            IS_VULNERABLE=1
        fi
    fi
    
    # react-server-dom-parcel ì ê²€
    if echo "$REACT_DEPS" | grep -q "react-server-dom-parcel"; then
        VERSION=$(echo "$REACT_DEPS" | grep "react-server-dom-parcel" | sed 's/.*: //; s/"//g; s/,//g; s/[^0-9.].*//g')
        log_result "âš  react-server-dom-parcel ë°œê²¬: $VERSION"
        
        if [[ "$VERSION" =~ ^19\.0$ ]] || [[ "$VERSION" =~ ^19\.1\.[01]$ ]] || [[ "$VERSION" =~ ^19\.2\.0$ ]]; then
            log_result "  ğŸ”´ ì·¨ì•½í•œ ë²„ì „ì…ë‹ˆë‹¤!"
            log_result "  ê¶Œì¥ ì¡°ì¹˜: 19.0.1, 19.1.2, ë˜ëŠ” 19.2.1 ì´ìƒìœ¼ë¡œ ì—…ë°ì´íŠ¸"
            IS_VULNERABLE=1
        fi
    fi
    
    # react-server-dom-turbopack ì ê²€
    if echo "$REACT_DEPS" | grep -q "react-server-dom-turbopack"; then
        VERSION=$(echo "$REACT_DEPS" | grep "react-server-dom-turbopack" | sed 's/.*: //; s/"//g; s/,//g; s/[^0-9.].*//g')
        log_result "âš  react-server-dom-turbopack ë°œê²¬: $VERSION"
        
        if [[ "$VERSION" =~ ^19\.0$ ]] || [[ "$VERSION" =~ ^19\.1\.[01]$ ]] || [[ "$VERSION" =~ ^19\.2\.0$ ]]; then
            log_result "  ğŸ”´ ì·¨ì•½í•œ ë²„ì „ì…ë‹ˆë‹¤!"
            log_result "  ê¶Œì¥ ì¡°ì¹˜: 19.0.1, 19.1.2, ë˜ëŠ” 19.2.1 ì´ìƒìœ¼ë¡œ ì—…ë°ì´íŠ¸"
            IS_VULNERABLE=1
        fi
    fi
    
    # Next.js ì ê²€
    if echo "$REACT_DEPS" | grep -q "\"next\""; then
        VERSION=$(echo "$REACT_DEPS" | grep "\"next\"" | sed 's/.*: //; s/"//g; s/,//g; s/[^0-9.].*//g')
        log_result "âš  Next.js ë°œê²¬: $VERSION"
        
        # ì·¨ì•½í•œ ë²„ì „ í™•ì¸
        if [[ "$VERSION" =~ ^15\.0\.[0-4]$ ]] || \
           [[ "$VERSION" =~ ^15\.1\.[0-8]$ ]] || \
           [[ "$VERSION" =~ ^15\.2\.[0-5]$ ]] || \
           [[ "$VERSION" =~ ^15\.3\.[0-5]$ ]] || \
           [[ "$VERSION" =~ ^15\.4\.[0-7]$ ]] || \
           [[ "$VERSION" =~ ^15\.5\.[0-6]$ ]] || \
           [[ "$VERSION" =~ ^16\.0\.[0-6]$ ]]; then
            log_result "  ğŸ”´ ì·¨ì•½í•œ ë²„ì „ì…ë‹ˆë‹¤!"
            log_result "  ê¶Œì¥ ì¡°ì¹˜:"
            
            if [[ "$VERSION" =~ ^15\.0 ]]; then
                log_result "    - 15.0.5 ì´ìƒìœ¼ë¡œ ì—…ë°ì´íŠ¸"
            elif [[ "$VERSION" =~ ^15\.1 ]]; then
                log_result "    - 15.1.9 ì´ìƒìœ¼ë¡œ ì—…ë°ì´íŠ¸"
            elif [[ "$VERSION" =~ ^15\.2 ]]; then
                log_result "    - 15.2.6 ì´ìƒìœ¼ë¡œ ì—…ë°ì´íŠ¸"
            elif [[ "$VERSION" =~ ^15\.3 ]]; then
                log_result "    - 15.3.6 ì´ìƒìœ¼ë¡œ ì—…ë°ì´íŠ¸"
            elif [[ "$VERSION" =~ ^15\.4 ]]; then
                log_result "    - 15.4.8 ì´ìƒìœ¼ë¡œ ì—…ë°ì´íŠ¸"
            elif [[ "$VERSION" =~ ^15\.5 ]]; then
                log_result "    - 15.5.7 ì´ìƒìœ¼ë¡œ ì—…ë°ì´íŠ¸"
            elif [[ "$VERSION" =~ ^16\.0 ]]; then
                log_result "    - 16.0.7 ì´ìƒìœ¼ë¡œ ì—…ë°ì´íŠ¸"
            fi
            IS_VULNERABLE=1
        elif [[ "$VERSION" =~ ^14\.3\. ]]; then
            # 14.3.0-canary.77 ì´ìƒì¸ ê²½ìš° canary í™•ì¸ í•„ìš”
            if echo "$VERSION" | grep -q "canary"; then
                log_result "  ğŸ”´ Canary ë²„ì „ìœ¼ë¡œ ì·¨ì•½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!"
                log_result "  ê¶Œì¥ ì¡°ì¹˜: 14.x ìµœì‹  ì•ˆì • ë²„ì „ìœ¼ë¡œ ë‹¤ìš´ê·¸ë ˆì´ë“œ"
                IS_VULNERABLE=1
            fi
        fi
    fi
    
    if [ $IS_VULNERABLE -eq 1 ]; then
        VULNERABLE_COUNT=$((VULNERABLE_COUNT + 1))
        log_result ""
        log_result "ğŸ”´ ì´ í”„ë¡œì íŠ¸ëŠ” ì·¨ì•½ì ì— ë…¸ì¶œë˜ì–´ ìˆìŠµë‹ˆë‹¤!"
    else
        SAFE_COUNT=$((SAFE_COUNT + 1))
        log_result ""
        log_result "âœ“ ì´ í”„ë¡œì íŠ¸ëŠ” ì•ˆì „í•œ ë²„ì „ì„ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤."
    fi
    
    log_result ""
    
done <<< "$PACKAGE_JSON_FILES"

# 5. ìµœì¢… ìš”ì•½
log_result "=================================================="
log_result "ì ê²€ ê²°ê³¼ ìš”ì•½"
log_result "=================================================="
log_result "ì´ í”„ë¡œì íŠ¸ ìˆ˜: $PROJECT_COUNT"
log_result "ì·¨ì•½í•œ í”„ë¡œì íŠ¸: $VULNERABLE_COUNT"
log_result "ì•ˆì „í•œ í”„ë¡œì íŠ¸: $SAFE_COUNT"
log_result ""

if [ $VULNERABLE_COUNT -gt 0 ]; then
    log_result "âš ï¸  ê²½ê³ : ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
    log_result ""
    log_result "ì¡°ì¹˜ ë°©ë²•:"
    log_result "1. ê° í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™"
    log_result "2. package.json íŒŒì¼ì„ ìˆ˜ì •í•˜ì—¬ ì•ˆì „í•œ ë²„ì „ìœ¼ë¡œ ë³€ê²½"
    log_result "3. npm install ë˜ëŠ” npm update ì‹¤í–‰"
    log_result "4. ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘"
    log_result ""
    log_result "ì°¸ê³ :"
    log_result "- CVE-2025-55182: React Server Components RCE ì·¨ì•½ì "
    log_result "- https://react.dev/blog/2025/12/03/critical-security-vulnerability-in-react-server-components"
    log_result "- https://nvd.nist.gov/vuln/detail/CVE-2025-55182"
else
    log_result "âœ“ ëª¨ë“  í”„ë¡œì íŠ¸ê°€ ì•ˆì „í•©ë‹ˆë‹¤."
fi

log_result ""
log_result "ë³´ê³ ì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤: $REPORT_FILE"
log_result "ì ê²€ ì¢…ë£Œ ì‹œê°„: $(date)"
log_result "=================================================="

echo ""
echo "ë³´ê³ ì„œ íŒŒì¼: $REPORT_FILE"
